generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  name                  String?
  password              String
  role                  String                 @default("CREW")
  phone                 String?
  avatar                String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  changeOrders          ChangeOrder[]
  correctiveActions     CorrectiveAction[]
  dailyReports          DailyReport[]          @relation("ReportCreator")
  signedReports         DailyReport[]          @relation("ReportSigner")
  estimates             Estimate[]             @relation("EstimateCreator")
  events                Event[]
  assignedInspections   Inspection[]           @relation("InspectionAssignee")
  inspections           Inspection[]           @relation("InspectionCreator")
  inventoryTransactions InventoryTransaction[]
  photos                Photo[]
  createdProjects       Project[]              @relation("ProjectCreator")
  rfis                  RFI[]                  @relation("RFICreator")
  rfiResponses          RFI[]                  @relation("RFIResponder")
  auditLogs             ReportAudit[]
  rodPasses             RodPass[]
  tmTickets             TMTicket[]
  ticket811Responses    Ticket811Response[]

  @@index([email])
  @@index([role])
}

model Project {
  id                    String                 @id @default(cuid())
  name                  String
  description           String?
  status                String                 @default("PLANNING")
  startDate             DateTime?
  endDate               DateTime?
  budget                Float?
  location              String?
  customerName          String?
  customerContact       String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  createdById           String
  assets                Asset[]
  bores                 Bore[]
  changeOrders          ChangeOrder[]
  dailyReports          DailyReport[]
  estimates             Estimate[]
  events                Event[]
  geotechReports        GeotechReport[]
  inspections           Inspection[]
  inventoryTransactions InventoryTransaction[]
  obstacles             Obstacle[]
  pits                  Pit[]
  createdBy             User                   @relation("ProjectCreator", fields: [createdById], references: [id])
  rfis                  RFI[]
  stationProgress       StationProgress[]
  tmTickets             TMTicket[]
  tickets811            Ticket811[]

  @@index([status])
  @@index([createdById])
}

model Bore {
  id              String         @id @default(cuid())
  projectId       String
  name            String
  alignment       String?
  depthProfile    String?
  diameterIn      Float?
  productMaterial String?
  tracerWire      Boolean        @default(false)
  entryPitId      String?
  exitPitId       String?
  status          String         @default("PLANNED")
  totalLength     Float?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  entryPit        Pit?           @relation("EntryPit", fields: [entryPitId], references: [id])
  exitPit         Pit?           @relation("ExitPit", fields: [exitPitId], references: [id])
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  borePlan        BorePlan?
  events          Event[]
  inspections     Inspection[]
  photos          Photo[]
  rfis            RFI[]
  rodPasses       RodPass[]
  telemetryLogs   TelemetryLog[]

  @@index([projectId])
  @@index([status])
  @@index([entryPitId])
  @@index([exitPitId])
}

model RodPass {
  id               String    @id @default(cuid())
  boreId           String
  sequence         Int
  passNumber       Int
  linearFeet       Float
  fluidMix         String?
  fluidVolumeGal   Float?
  pitch            Float?
  azimuth          Float?
  depth            Float?
  viscosity        Float?
  mudWeight        Float?
  reamerDiameter   Float?
  steeringToolFace Float?
  startedAt        DateTime?
  completedAt      DateTime?
  notes            String?
  loggedById       String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  bore             Bore      @relation(fields: [boreId], references: [id], onDelete: Cascade)
  loggedBy         User      @relation(fields: [loggedById], references: [id])

  @@index([boreId])
  @@index([sequence])
  @@index([loggedById])
}

model TelemetryLog {
  id           String   @id @default(cuid())
  boreId       String
  timestamp    DateTime
  depth        Float
  pitch        Float?
  azimuth      Float?
  toolFace     Float?
  rpm          Float?
  wob          Float?
  torque       Float?
  pumpPressure Float?
  flowRate     Float?
  createdAt    DateTime @default(now())
  bore         Bore     @relation(fields: [boreId], references: [id], onDelete: Cascade)

  @@index([boreId])
  @@index([timestamp])
}

model DailyReport {
  id          String        @id @default(cuid())
  projectId   String
  reportDate  DateTime
  crew        String
  production  String        @default("[]")
  labor       String        @default("[]")
  equipment   String        @default("[]")
  materials   String        @default("[]")
  weather     String?
  notes       String?
  photos      String        @default("[]")
  status      String        @default("DRAFT")
  signedById  String?
  signedAt    DateTime?
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   User          @relation("ReportCreator", fields: [createdById], references: [id])
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  signedBy    User?         @relation("ReportSigner", fields: [signedById], references: [id])
  photosNew   Photo[]
  auditLogs   ReportAudit[]

  @@unique([projectId, reportDate])
  @@index([projectId])
  @@index([reportDate])
  @@index([status])
  @@index([createdById])
  @@index([signedById])
}

model ReportAudit {
  id          String      @id @default(cuid())
  reportId    String
  changedById String
  changedAt   DateTime    @default(now())
  changes     String
  snapshot    String
  updatedAt   DateTime    @updatedAt
  changedBy   User        @relation(fields: [changedById], references: [id])
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([changedById])
}

model Inspection {
  id                String             @id @default(cuid())
  projectId         String
  boreId            String?
  templateName      String?
  items             String
  assigneeId        String?
  dueDate           DateTime?
  completedAt       DateTime?
  status            String             @default("OPEN")
  location          String?
  createdById       String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  correctiveActions CorrectiveAction[]
  assignee          User?              @relation("InspectionAssignee", fields: [assigneeId], references: [id])
  bore              Bore?              @relation(fields: [boreId], references: [id])
  createdBy         User               @relation("InspectionCreator", fields: [createdById], references: [id])
  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  photos            Photo[]

  @@index([projectId])
  @@index([status])
  @@index([boreId])
  @@index([assigneeId])
  @@index([createdById])
}

model CorrectiveAction {
  id           String     @id @default(cuid())
  inspectionId String
  description  String
  assigneeId   String
  dueDate      DateTime
  status       String     @default("OPEN")
  resolution   String?
  closedAt     DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  assignee     User       @relation(fields: [assigneeId], references: [id])
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([status])
  @@index([assigneeId])
}

model RFI {
  id            String        @id @default(cuid())
  projectId     String
  boreId        String?
  question      String
  location      String?
  requiredBy    DateTime?
  status        String        @default("OPEN")
  response      String?
  respondedById String?
  respondedAt   DateTime?
  attachments   String        @default("[]")
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  changeOrders  ChangeOrder[]
  bore          Bore?         @relation(fields: [boreId], references: [id])
  createdBy     User          @relation("RFICreator", fields: [createdById], references: [id])
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  respondedBy   User?         @relation("RFIResponder", fields: [respondedById], references: [id])
  tmTickets     TMTicket[]

  @@index([projectId])
  @@index([status])
  @@index([boreId])
  @@index([createdById])
  @@index([respondedById])
}

model TMTicket {
  id           String        @id @default(cuid())
  projectId    String
  rfiId        String?
  lineItems    String
  status       String        @default("DRAFT")
  approvedById String?
  approvedAt   DateTime?
  photos       String        @default("[]")
  signature    String?
  createdById  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  changeOrders ChangeOrder[]
  createdBy    User          @relation(fields: [createdById], references: [id])
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rfi          RFI?          @relation(fields: [rfiId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([rfiId])
  @@index([createdById])
}

model ChangeOrder {
  id           String    @id @default(cuid())
  projectId    String
  tmTicketId   String?
  rfiId        String?
  scope        String
  pricing      String?
  budgetImpact Float?
  status       String    @default("PENDING")
  approvedById String?
  approvedAt   DateTime?
  createdById  String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdBy    User      @relation(fields: [createdById], references: [id])
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rfi          RFI?      @relation(fields: [rfiId], references: [id])
  tmTicket     TMTicket? @relation(fields: [tmTicketId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([tmTicketId])
  @@index([rfiId])
  @@index([createdById])
}

model Ticket811 {
  id             String              @id @default(cuid())
  projectId      String
  ticketNumber   String
  ticketDate     DateTime
  expirationDate DateTime
  status         String              @default("ACTIVE")
  notes          String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  project        Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responses      Ticket811Response[]

  @@index([projectId])
  @@index([expirationDate])
  @@index([status])
}

model Ticket811Response {
  id               String    @id @default(cuid())
  ticketId         String
  utilityName      String
  responseType     String?
  responseDate     DateTime
  locatePhotos     String    @default("[]")
  marksDescription String?
  respondedById    String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  respondedBy      User      @relation(fields: [respondedById], references: [id])
  ticket           Ticket811 @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([respondedById])
}

model Event {
  id          String   @id @default(cuid())
  projectId   String
  boreId      String?
  type        String
  location    String?
  description String
  photos      String   @default("[]")
  timestamp   DateTime @default(now())
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  bore        Bore?    @relation(fields: [boreId], references: [id])
  createdBy   User     @relation(fields: [createdById], references: [id])
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([timestamp])
  @@index([boreId])
  @@index([createdById])
}

model Pit {
  id         String   @id @default(cuid())
  projectId  String
  boreId     String?
  type       String?
  location   String?
  elevation  Float?
  notes      String?
  photos     String   @default("[]")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  entryBores Bore[]   @relation("EntryPit")
  exitBores  Bore[]   @relation("ExitPit")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  service   String?
  message   String
  status    String   @default("NEW")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
}

model Photo {
  id            String       @id @default(cuid())
  filename      String
  url           String
  thumbnailUrl  String?
  size          Int
  mimeType      String
  boreId        String?
  inspectionId  String?
  dailyReportId String?
  uploadedById  String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  bore          Bore?        @relation(fields: [boreId], references: [id], onDelete: Cascade)
  dailyReport   DailyReport? @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  inspection    Inspection?  @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  uploadedBy    User         @relation(fields: [uploadedById], references: [id])

  @@index([boreId])
  @@index([inspectionId])
  @@index([dailyReportId])
  @@index([uploadedById])
}

model CostCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  costItems   CostItem[]

  @@index([isActive])
}

model CostItem {
  id             String         @id @default(cuid())
  categoryId     String
  code           String         @unique
  name           String
  description    String?
  unit           String
  unitCost       Float
  laborRate      Float?
  equipmentRate  Float?
  materialCost   Float?
  productionRate Float?
  markup         Float          @default(0.15)
  isActive       Boolean        @default(true)
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  category       CostCategory   @relation(fields: [categoryId], references: [id])
  estimateLines  EstimateLine[]

  @@index([categoryId])
  @@index([code])
  @@index([isActive])
}

model Estimate {
  id            String         @id @default(cuid())
  projectId     String?
  name          String
  description   String?
  status        String         @default("DRAFT")
  customerName  String?
  customerEmail String?
  customerPhone String?
  validUntil    DateTime?
  subtotal      Float          @default(0)
  markupPercent Float          @default(0.15)
  markupAmount  Float          @default(0)
  taxPercent    Float          @default(0)
  taxAmount     Float          @default(0)
  total         Float          @default(0)
  notes         String?
  terms         String?
  createdById   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     User           @relation("EstimateCreator", fields: [createdById], references: [id])
  project       Project?       @relation(fields: [projectId], references: [id])
  lines         EstimateLine[]

  @@index([projectId])
  @@index([status])
  @@index([createdById])
}

model EstimateLine {
  id            String    @id @default(cuid())
  estimateId    String
  costItemId    String?
  lineNumber    Int
  description   String
  quantity      Float
  unit          String
  unitCost      Float
  laborCost     Float     @default(0)
  equipmentCost Float     @default(0)
  materialCost  Float     @default(0)
  subtotal      Float
  markup        Float     @default(0)
  total         Float
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  costItem      CostItem? @relation(fields: [costItemId], references: [id])
  estimate      Estimate  @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  @@index([estimateId])
  @@index([costItemId])
}

model GeotechReport {
  id          String      @id @default(cuid())
  projectId   String
  title       String
  reportDate  DateTime
  engineer    String?
  description String?
  pdfUrl      String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  soilLayers  SoilLayer[]

  @@index([projectId])
}

model SoilLayer {
  id              String        @id @default(cuid())
  geotechReportId String
  startDepth      Float
  endDepth        Float
  soilType        String
  description     String?
  color           String?
  hardness        Float?
  phpaRequired    Boolean       @default(false)
  rockStrengthPsi Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  geotechReport   GeotechReport @relation(fields: [geotechReportId], references: [id], onDelete: Cascade)

  @@index([geotechReportId])
}

model BorePlan {
  id            String     @id @default(cuid())
  boreId        String     @unique
  designMethod  String?
  totalLength   Float
  pipeDiameter  Float
  pipeMaterial  String
  entryAngle    Float?
  exitAngle     Float?
  bendRadius    Float?
  pullbackForce Float?
  safetyFactor  Float?
  fracOutRisk   String?
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  bore          Bore       @relation(fields: [boreId], references: [id], onDelete: Cascade)
  fluidPlan     FluidPlan?
}

model FluidPlan {
  id           String   @id @default(cuid())
  borePlanId   String   @unique
  soilType     String
  pumpRate     Float?
  fluidType    String?
  additives    String?
  volumePerFt  Float?
  totalVolume  Float?
  cleaningRate Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  borePlan     BorePlan @relation(fields: [borePlanId], references: [id], onDelete: Cascade)
}

model InventoryItem {
  id             String                 @id @default(cuid())
  name           String
  sku            String?                @unique
  category       String
  description    String?
  unit           String
  quantityOnHand Float                  @default(0)
  reorderPoint   Float?
  location       String?
  costPerUnit    Float?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  transactions   InventoryTransaction[]
}

model InventoryTransaction {
  id        String        @id @default(cuid())
  itemId    String
  type      String
  quantity  Float
  projectId String?
  userId    String
  notes     String?
  createdAt DateTime      @default(now())
  item      InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  project   Project?      @relation(fields: [projectId], references: [id])
  user      User          @relation(fields: [userId], references: [id])

  @@index([itemId])
  @@index([projectId])
}

model Obstacle {
  id           String   @id @default(cuid())
  projectId    String
  name         String
  type         String
  startX       Float
  startY       Float
  startZ       Float
  endX         Float?
  endY         Float?
  endZ         Float?
  diameter     Float?
  safetyBuffer Float    @default(2.0)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Asset {
  id           String    @id @default(cuid())
  name         String
  type         String
  model        String?
  serialNumber String?
  status       String    @default("AVAILABLE")
  projectId    String?
  purchaseDate DateTime?
  hours        Float?
  location     String?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  project      Project?  @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([type])
}

model StationProgress {
  id           String   @id @default(cuid())
  projectId    String
  date         DateTime
  startStation Float
  endStation   Float
  status       String
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
}

model Tooling {
  id           String   @id @default(cuid())
  name         String
  type         String
  serialNumber String?
  condition    String   @default("GOOD")
  hoursUsed    Float    @default(0)
  maxHours     Float?
  location     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
