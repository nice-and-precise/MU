generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  name                  String?
  password              String
  role                  String                 @default("CREW")
  phone                 String?
  avatar                String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  changeOrders          ChangeOrder[]
  correctiveActions     CorrectiveAction[]
  dailyReports          DailyReport[]          @relation("ReportCreator")
  signedReports         DailyReport[]          @relation("ReportSigner")
  estimates             Estimate[]             @relation("EstimateCreator")
  events                Event[]
  assignedInspections   Inspection[]           @relation("InspectionAssignee")
  inspections           Inspection[]           @relation("InspectionCreator")
  inventoryTransactions InventoryTransaction[]
  photos                Photo[]
  createdProjects       Project[]              @relation("ProjectCreator")
  rfis                  RFI[]                  @relation("RFICreator")
  rfiResponses          RFI[]                  @relation("RFIResponder")
  auditLogs             ReportAudit[]
  rodPasses             RodPass[]
  tmTickets             TMTicket[]
  createdInvoices       Invoice[]
  assignedPunchItems    PunchItem[]
  potholes              Pothole[]
  jobAssets             JobAsset[]
  jobDocuments          JobDocument[]          @relation("DocumentCreator")
  dailyNotes            DailyNote[]            @relation("NoteAuthor")
  expenses              Expense[]
  employee              Employee?

  whiteLiningSnapshots  WhiteLiningSnapshot[]
  complianceEvents      ComplianceEvent[]

  @@index([email])
  @@index([role])
}

model Project {
  id                    String                 @id @default(cuid())
  name                  String
  description           String?
  status                String                 @default("PLANNING")
  startDate             DateTime?
  endDate               DateTime?
  budget                Float?
  location              String?
  customerName          String?
  customerContact       String?
  latitude              Float?
  longitude             Float?
  radius                Float                  @default(500) // Geofence radius in feet
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  createdById           String
  qboCustomerId         String?
  machineRate           Float?
  assets                Asset[]
  bores                 Bore[]
  changeOrders          ChangeOrder[]
  dailyReports          DailyReport[]
  estimates             Estimate[]
  events                Event[]
  geotechReports        GeotechReport[]
  inspections           Inspection[]
  inventoryTransactions InventoryTransaction[]
  obstacles             Obstacle[]
  pits                  Pit[]
  potholes              Pothole[]
  createdBy             User                   @relation("ProjectCreator", fields: [createdById], references: [id])
  rfis                  RFI[]
  stationProgress       StationProgress[]
  tmTickets             TMTicket[]
  tickets811            Ticket811[]
  invoices              Invoice[]
  timeCards             TimeCard[]
  equipmentUsage        EquipmentUsage[]
  safetyMeetings        SafetyMeeting[]
  jsas                  JSA[]
  punchItems            PunchItem[]
  photos                Photo[]
  jobAssets             JobAsset[]
  jobDocuments          JobDocument[]
  dailyNotes            DailyNote[]
  incidents             SafetyIncident[]
  timeEntries           TimeEntry[]
  expenses              Expense[]

  gsocTickets           GsocTicket[]
  damageEvents          DamageEvent[]
  complianceEvents      ComplianceEvent[]
  shifts                Shift[]

  @@index([status])
  @@index([createdById])
}





model Bore {
  id              String         @id @default(cuid())
  projectId       String
  name            String
  alignment       String?
  depthProfile    String?
  diameterIn      Float?
  productMaterial String?
  tracerWire      Boolean        @default(false)
  entryPitId      String?
  exitPitId       String?
  status          String         @default("PLANNED")
  dip             Float          @default(0)
  declination     Float          @default(0)
  totalLength     Float?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  entryPit        Pit?           @relation("EntryPit", fields: [entryPitId], references: [id])
  exitPit         Pit?           @relation("ExitPit", fields: [exitPitId], references: [id])
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  borePlan        BorePlan?
  events          Event[]
  inspections     Inspection[]
  photos          Photo[]
  rfis            RFI[]
  rodPasses       RodPass[]
  telemetryLogs   TelemetryLog[]

  @@index([projectId])
  @@index([status])
  @@index([entryPitId])
  @@index([exitPitId])
}

model RodPass {
  id               String    @id @default(cuid())
  boreId           String
  sequence         Int
  passNumber       Int
  linearFeet       Float
  fluidMix         String?
  fluidVolumeGal   Float?
  pitch            Float?
  azimuth          Float?
  depth            Float?
  north            Float?         @default(0)
  east             Float?         @default(0)
  dls              Float?         @default(0)
  viscosity        Float?
  mudWeight        Float?
  reamerDiameter   Float?
  steeringToolFace Float?
  startedAt        DateTime?
  completedAt      DateTime?
  notes            String?
  loggedById       String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  bore             Bore      @relation(fields: [boreId], references: [id], onDelete: Cascade)
  loggedBy         User      @relation(fields: [loggedById], references: [id])
  pullbackForce    Float?
  returnsVisual    String?   // "Full Returns", "Partial Loss", "Total Loss"

  @@index([boreId])
  @@index([sequence])
  @@index([loggedById])
}

model Pothole {
  id                    String   @id @default(cuid())
  projectId             String
  project               Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  utilityType           String
  depth                 Float
  visualVerificationPhoto String // URL to photo
  notes                 String?
  createdById           String
  createdBy             User     @relation(fields: [createdById], references: [id])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([projectId])
}

model TelemetryLog {
  id           String   @id @default(cuid())
  boreId       String
  timestamp    DateTime
  depth        Float
  pitch        Float?
  azimuth      Float?
  toolFace     Float?
  rpm          Float?
  wob          Float?
  torque       Float?
  pumpPressure Float?
  flowRate     Float?
  createdAt    DateTime @default(now())
  bore         Bore     @relation(fields: [boreId], references: [id], onDelete: Cascade)

  @@index([boreId])
  @@index([timestamp])
}

model DailyReport {
  id          String        @id @default(cuid())
  projectId   String
  reportDate  DateTime
  crew        String
  production  String        @default("[]")
  labor       String        @default("[]")
  equipment   String        @default("[]")
  materials   String        @default("[]")
  weather     String?
  notes       String?
  photos      String        @default("[]")
  status      String        @default("DRAFT")
  signedById  String?
  signedAt    DateTime?
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   User          @relation("ReportCreator", fields: [createdById], references: [id])
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  signedBy    User?         @relation("ReportSigner", fields: [signedById], references: [id])
  photosNew   Photo[]
  auditLogs   ReportAudit[]

  @@unique([projectId, reportDate])
  @@index([projectId])
  @@index([reportDate])
  @@index([status])
  @@index([createdById])
  @@index([signedById])
}

model ReportAudit {
  id          String      @id @default(cuid())
  reportId    String
  changedById String
  changedAt   DateTime    @default(now())
  changes     String
  snapshot    String
  updatedAt   DateTime    @updatedAt
  changedBy   User        @relation(fields: [changedById], references: [id])
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([changedById])
}

model Inspection {
  id                String             @id @default(cuid())
  projectId         String
  boreId            String?
  assetId           String?
  templateName      String?
  type              String             @default("General") // Pre-Trip, Site, Vehicle
  items             String             @default("[]") // JSON string of checklist items
  assigneeId        String?
  dueDate           DateTime?
  completedAt       DateTime?
  status            String             @default("OPEN")
  passed            Boolean            @default(true)
  location          String?
  notes             String?
  createdById       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  correctiveActions CorrectiveAction[]
  assignee          User?              @relation("InspectionAssignee", fields: [assigneeId], references: [id])
  bore              Bore?              @relation(fields: [boreId], references: [id])
  asset             Asset?             @relation(fields: [assetId], references: [id])
  createdBy         User?              @relation("InspectionCreator", fields: [createdById], references: [id])
  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  photos            Photo[]

  @@index([projectId])
  @@index([status])
  @@index([boreId])
  @@index([assetId])
  @@index([assigneeId])
  @@index([createdById])
}

model CorrectiveAction {
  id           String     @id @default(cuid())
  inspectionId String
  description  String
  assigneeId   String
  dueDate      DateTime
  status       String     @default("OPEN")
  resolution   String?
  closedAt     DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  assignee     User       @relation(fields: [assigneeId], references: [id])
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([status])
  @@index([assigneeId])
}

model RFI {
  id            String        @id @default(cuid())
  projectId     String
  boreId        String?
  question      String
  location      String?
  requiredBy    DateTime?
  status        String        @default("OPEN")
  response      String?
  respondedById String?
  respondedAt   DateTime?
  attachments   String        @default("[]")
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  changeOrders  ChangeOrder[]
  bore          Bore?         @relation(fields: [boreId], references: [id])
  createdBy     User          @relation("RFICreator", fields: [createdById], references: [id])
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  respondedBy   User?         @relation("RFIResponder", fields: [respondedById], references: [id])
  tmTickets     TMTicket[]

  @@index([projectId])
  @@index([status])
  @@index([boreId])
  @@index([createdById])
  @@index([respondedById])
}

model TMTicket {
  id           String        @id @default(cuid())
  projectId    String
  rfiId        String?
  lineItems    String
  status       String        @default("DRAFT")
  approvedById String?
  approvedAt   DateTime?
  photos       String        @default("[]")
  signature    String?
  createdById  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  changeOrders ChangeOrder[]
  createdBy    User          @relation(fields: [createdById], references: [id])
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rfi          RFI?          @relation(fields: [rfiId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([rfiId])
  @@index([createdById])
}

model ChangeOrder {
  id           String    @id @default(cuid())
  projectId    String
  tmTicketId   String?
  rfiId        String?
  scope        String
  pricing      String?
  budgetImpact Float?
  status       String    @default("PENDING")
  approvedById String?
  approvedAt   DateTime?
  createdById  String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdBy    User      @relation(fields: [createdById], references: [id])
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rfi          RFI?      @relation(fields: [rfiId], references: [id])
  tmTicket     TMTicket? @relation(fields: [tmTicketId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([tmTicketId])
  @@index([rfiId])
  @@index([createdById])
}

model Ticket811 {
  id                  String              @id @default(cuid())
  ticketNumber        String              @unique
  type                String              @default("NORMAL") // Normal, Emergency, Meet, etc.
  status              String              @default("ACTIVE") // Active, Expired, Closed
  
  // Dates
  submittedAt         DateTime
  workToBeginDate     DateTime
  expirationDate      DateTime
  
  // Contact Info
  company             String
  caller              String
  phone               String
  email               String?
  
  // Location
  workSiteAddress     String
  city                String?
  county              String?
  nearestIntersection String?
  gpsCoordinates      String?
  
  // Details
  markingInstructions String?
  workDescription     String?
  duration            String?
  explosives          Boolean             @default(false)
  tunneling           Boolean             @default(false)
  rightOfWay          Boolean             @default(false)
  
  // Utilities
  utilitiesNotified   String              @default("[]") // JSON array of utility names
  
  // Links
  mapLink             String?
  
  // Internal
  projectId           String?
  notes               String?
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  project             Project?            @relation(fields: [projectId], references: [id])
  responses           Ticket811Response[]

  @@index([projectId])
  @@index([expirationDate])
  @@index([status])
  @@index([ticketNumber])
}

model Ticket811Response {
  id               String    @id @default(cuid())
  ticketId         String
  utilityName      String
  status           String    // Marked, Clear, Conflict, etc.
  responseDate     DateTime?
  notes            String?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  ticket           Ticket811 @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([utilityName])
}

model Event {
  id          String   @id @default(cuid())
  projectId   String
  boreId      String?
  type        String
  location    String?
  description String
  photos      String   @default("[]")
  timestamp   DateTime @default(now())
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  bore        Bore?    @relation(fields: [boreId], references: [id])
  createdBy   User     @relation(fields: [createdById], references: [id])
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([timestamp])
  @@index([boreId])
  @@index([createdById])
}

model Pit {
  id         String   @id @default(cuid())
  projectId  String
  boreId     String?
  type       String?
  location   String?
  elevation  Float?
  notes      String?
  photos     String   @default("[]")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  entryBores Bore[]   @relation("EntryPit")
  exitBores  Bore[]   @relation("ExitPit")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  service   String?
  message   String
  status    String   @default("NEW")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
}

model Photo {
  id            String       @id @default(cuid())
  filename      String
  url           String
  thumbnailUrl  String?
  size          Int
  mimeType      String
  boreId        String?
  inspectionId  String?
  dailyReportId String?
  uploadedById  String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  bore          Bore?        @relation(fields: [boreId], references: [id], onDelete: Cascade)
  dailyReport   DailyReport? @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  inspection    Inspection?  @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  uploadedBy    User         @relation(fields: [uploadedById], references: [id])
  projectId     String?
  project       Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([boreId])
  @@index([inspectionId])
  @@index([projectId])
  @@index([dailyReportId])
  @@index([uploadedById])
}

model PunchItem {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?
  status      String   @default("OPEN") // OPEN, COMPLETED
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  assigneeId  String?
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([assigneeId])
}

model CostCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  costItems   CostItem[]

  @@index([isActive])
}

model CostItem {
  id             String         @id @default(cuid())
  categoryId     String
  code           String         @unique
  name           String
  description    String?
  unit           String
  unitCost       Float
  laborRate      Float?
  equipmentRate  Float?
  materialCost   Float?
  productionRate Float?
  markup         Float          @default(0.15)
  isActive       Boolean        @default(true)
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  category       CostCategory   @relation(fields: [categoryId], references: [id])
  estimateLines  EstimateLine[]

  @@index([categoryId])
  @@index([code])
  @@index([isActive])
}

model Estimate {
  id            String         @id @default(cuid())
  projectId     String?
  name          String
  description   String?
  status        String         @default("DRAFT")
  customerName  String?
  customerEmail String?
  customerPhone String?
  validUntil    DateTime?
  subtotal      Float          @default(0)
  markupPercent Float          @default(0.15)
  markupAmount  Float          @default(0)
  taxPercent    Float          @default(0)
  taxAmount     Float          @default(0)
  total         Float          @default(0)
  notes         String?
  terms         String?
  createdById   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     User           @relation("EstimateCreator", fields: [createdById], references: [id])
  project       Project?       @relation(fields: [projectId], references: [id])
  lines         EstimateLine[]

  @@index([projectId])
  @@index([status])
  @@index([createdById])
}

model EstimateLine {
  id            String    @id @default(cuid())
  estimateId    String
  costItemId    String?
  lineNumber    Int
  description   String
  quantity      Float
  unit          String
  unitCost      Float
  laborCost     Float     @default(0)
  equipmentCost Float     @default(0)
  materialCost  Float     @default(0)
  subtotal      Float
  markup        Float     @default(0)
  total         Float
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  costItem      CostItem? @relation(fields: [costItemId], references: [id])
  estimate      Estimate  @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  @@index([estimateId])
  @@index([costItemId])
}

model GeotechReport {
  id          String      @id @default(cuid())
  projectId   String
  title       String
  reportDate  DateTime
  engineer    String?
  description String?
  pdfUrl      String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  soilLayers  SoilLayer[]

  @@index([projectId])
}

model SoilLayer {
  id              String        @id @default(cuid())
  geotechReportId String
  startDepth      Float
  endDepth        Float
  soilType        String
  description     String?
  color           String?
  hardness        Float?
  phpaRequired    Boolean       @default(false)
  rockStrengthPsi Float?
  shearModulus    Float?
  poissonRatio    Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  geotechReport   GeotechReport @relation(fields: [geotechReportId], references: [id], onDelete: Cascade)

  @@index([geotechReportId])
}

model BorePlan {
  id            String     @id @default(cuid())
  boreId        String     @unique
  designMethod  String?
  totalLength   Float
  pipeDiameter  Float
  pipeMaterial  String
  entryAngle    Float?
  exitAngle     Float?
  bendRadius    Float?
  pullbackForce Float?
  safetyFactor  Float?
  fracOutRisk   String?
  planData      String     @default("[]") // JSON string of PlannedRod[]
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  bore          Bore       @relation(fields: [boreId], references: [id], onDelete: Cascade)
  fluidPlan     FluidPlan?
}

model FluidPlan {
  id           String   @id @default(cuid())
  borePlanId   String   @unique
  soilType     String
  pumpRate     Float?
  fluidType    String?
  additives    String?
  volumePerFt  Float?
  totalVolume  Float?
  cleaningRate Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  borePlan     BorePlan @relation(fields: [borePlanId], references: [id], onDelete: Cascade)
}

model InventoryItem {
  id             String                 @id @default(cuid())
  name           String
  sku            String?                @unique
  category       String
  description    String?
  unit           String
  quantityOnHand Float                  @default(0)
  reorderPoint   Float?
  location       String?
  costPerUnit    Float?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  transactions   InventoryTransaction[]
}

model InventoryTransaction {
  id        String        @id @default(cuid())
  itemId    String
  type      String
  quantity  Float
  projectId String?
  userId    String
  notes     String?
  createdAt DateTime      @default(now())
  item      InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  project   Project?      @relation(fields: [projectId], references: [id])
  user      User          @relation(fields: [userId], references: [id])

  @@index([itemId])
  @@index([projectId])
}

model Obstacle {
  id           String   @id @default(cuid())
  projectId    String
  name         String
  type         String
  startX       Float
  startY       Float
  startZ       Float
  endX         Float?
  endY         Float?
  endZ         Float?
  diameter     Float?
  safetyBuffer Float    @default(2.0)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Asset {
  id           String    @id @default(cuid())
  name         String
  type         String
  model        String?
  serialNumber String?
  status       String    @default("Active") // Active, Maintenance, Retired
  projectId    String?
  purchaseDate DateTime?
  hours        Float?
  location     String?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  project      Project?  @relation(fields: [projectId], references: [id])
  hourlyRate   Float?
  maintenanceLogs MaintenanceLog[]
  usageLogs       EquipmentUsage[]
  inspections     Inspection[]
  jobAssets       JobAsset[]
  shiftAssignments ShiftAsset[]

  @@index([projectId])
  @@index([status])
  @@index([type])
}

model MaintenanceLog {
  id          String   @id @default(cuid())
  assetId     String
  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  date        DateTime
  type        String   // Preventative, Repair, Inspection
  description String
  cost        Float    @default(0)
  performedBy String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([assetId])
}

model EquipmentUsage {
  id        String   @id @default(cuid())
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  date      DateTime
  hours     Float
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId])
  @@index([projectId])
}

model SafetyMeeting {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  date      DateTime
  topic     String
  attendees String[] // List of names or IDs
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

model JSA {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  date            DateTime
  taskDescription String
  hazards         String   @default("[]") // JSON string of hazards
  controls        String   @default("[]") // JSON string of controls
  signatures      String   @default("[]") // JSON string of signatures
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
}



model StationProgress {
  id           String   @id @default(cuid())
  projectId    String
  date         DateTime
  startStation Float
  endStation   Float
  status       String
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
  @@index([status])
}

model Tooling {
  id           String   @id @default(cuid())
  name         String
  type         String
  serialNumber String?
  condition    String   @default("GOOD")
  hoursUsed    Float    @default(0)
  maxHours     Float?
  location     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Invoice {
  id              String        @id @default(cuid())
  projectId       String
  applicationNo   Int
  periodStart     DateTime
  periodEnd       DateTime
  status          String        @default("DRAFT")
  totalCompleted  Float         @default(0)
  retainagePercent Float        @default(0.10)
  retainageAmount Float         @default(0)
  totalEarned     Float         @default(0)
  previousBilled  Float         @default(0)
  currentDue      Float         @default(0)
  notes           String?
  createdById     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       User          @relation(fields: [createdById], references: [id])
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items           InvoiceItem[]

  @@index([projectId])
  @@index([status])
}

model InvoiceItem {
  id             String   @id @default(cuid())
  invoiceId      String
  description    String
  scheduledValue Float
  previous       Float    @default(0)
  thisPeriod     Float    @default(0)
  stored         Float    @default(0)
  totalCompleted Float    @default(0)
  percentComplete Float   @default(0)
  balance        Float    @default(0)
  retainage      Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Employee {
  id          String     @id @default(cuid())
  userId      String?    @unique // Link to auth user
  user        User?      @relation(fields: [userId], references: [id])
  
  // Personal Info
  firstName   String
  lastName    String
  email       String?
  phone       String?
  address     String?
  ssn         String?    // Encrypted or masked in app logic
  dob         DateTime?
  emergencyContact String? // JSON or simple string

  // Employment Info
  role        String     // Foreman, Operator, Laborer, Office
  position    String?    // Detailed position e.g. "Drill Operator", "Locator"
  status      String     @default("ACTIVE") // ACTIVE, TERMINATED, LEAVE
  hireDate    DateTime?
  terminationDate DateTime?
  
  // Payroll
  payType     String     @default("HOURLY") // HOURLY, SALARY
  hourlyRate  Float      @default(0)
  salary      Float?
  taxStatus   String?    // W-4 Single, etc.
  qboEmployeeId String?
  adpEmployeeId String?
  
  // Relations
  crews       CrewMember[]
  foremanCrews Crew[]    @relation("CrewForeman")
  timeCards   TimeCard[]
  timeEntries TimeEntry[]
  certs       Certification[]
  incidents   SafetyIncident[]
  documents   StaffDocument[]
  reviews     PerformanceReview[]
  statusHistory EmploymentStatusHistory[]
  shifts        Shift[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model EmploymentStatusHistory {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  status      String
  reason      String?
  effectiveDate DateTime
  createdAt   DateTime @default(now())
  createdBy   String?
}

model Crew {
  id        String     @id @default(cuid())
  name      String
  foremanId String
  foreman   Employee   @relation("CrewForeman", fields: [foremanId], references: [id])
  members   CrewMember[]
  shifts    Shift[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CrewMember {
  id        String    @id @default(cuid())
  crewId    String
  crew      Crew      @relation(fields: [crewId], references: [id], onDelete: Cascade)
  employeeId String
  employee  Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  role      String?
  startDate DateTime  @default(now())
  endDate   DateTime?
  
  @@index([crewId])
  @@index([employeeId])
}

model TimeEntry {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id])
  
  startTime   DateTime
  startLat    Float?
  startLong   Float?
  
  endTime     DateTime?
  endLat      Float?
  endLong     Float?
  
  type        String    @default("WORK") // WORK, TRAVEL, BREAK
  description String?
  
  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([projectId])
  @@index([startTime])
}

model TimeCard {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id])
  
  periodStart DateTime
  periodEnd   DateTime
  
  totalRegularHours Float @default(0)
  totalOvertime     Float @default(0)
  
  status      String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED
  
  // Legacy fields for backward compatibility or direct entry
  date       DateTime?
  hours      Float?
  code       String?   // e.g., "Drilling", "Mobilization"
  payrollItem String? // QBO Payroll Item Ref
  serviceItem String? // QBO Service Item Ref
  clockInTime DateTime?
  clockOutTime DateTime?
  clockInLat  Float?
  clockInLong Float?
  isGeofenced Boolean    @default(false)
  notes      String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Certification {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  name        String
  provider    String?
  issuedDate  DateTime?
  expiresDate DateTime?
  documentUrl String?
  status      String    @default("ACTIVE") // ACTIVE, EXPIRED
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([employeeId])
}

model SafetyIncident {
  id          String    @id @default(cuid())
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id])
  employeeId  String?   // Main employee involved
  employee    Employee? @relation(fields: [employeeId], references: [id])
  
  date        DateTime
  type        String    // INJURY, NEAR_MISS, PROPERTY_DAMAGE
  severity    String    // LOW, MEDIUM, HIGH, CRITICAL
  description String
  location    String?
  
  photos      String    @default("[]")
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([projectId])
  @@index([employeeId])
}

model StaffDocument {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  name        String
  type        String    // POLICY, CONTRACT, FORM
  url         String
  status      String    @default("PENDING") // PENDING, SIGNED
  signedAt    DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model PerformanceReview {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reviewerId  String
  date        DateTime
  rating      Int?      // 1-5
  summary     String?
  goals       String?   // JSON
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model JobAsset {
  id          String   @id @default(cuid())
  assetId     String
  asset       Asset    @relation(fields: [assetId], references: [id])
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  assignedById String
  assignedBy  User     @relation(fields: [assignedById], references: [id])
  assignedDate DateTime @default(now())
  returnedDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobDocument {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  name        String
  type        String   // Plan, Permit, Safety
  url         String
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation("DocumentCreator", fields: [createdById], references: [id])
}

model DailyNote {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  date        DateTime
  content     String
  authorId    String
  author      User     @relation("NoteAuthor", fields: [authorId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Expense {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  date        DateTime
  category    String   // e.g., "Fuel", "Per Diem", "Material", "Subcontractor"
  description String
  amount      Float
  vendor      String?
  receiptUrl  String?
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([category])
  @@index([date])
}
// ... existing code ...

// --- 216D Compliance Models ---

model GsocTicket {
  id                     String                @id @default(cuid())
  projectId              String
  project                Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ticketNumber           String
  ticketType             String                // NORMAL, EMERGENCY, MEET, UPDATE, DESIGN, PLANNING
  filedAt                DateTime              // When GSOC confirmed
  legalLocateReadyAt     DateTime?             // Computed: 48h rule
  legalExcavationStartAt DateTime?             // Computed: 48h rule or post-meet
  startTimeFromGsoc      DateTime              // The start time on the ticket
  expirationAt           DateTime?             // 14 days rule
  status                 String                @default("DRAFT") // DRAFT, SUBMITTED, LOCATES_DUE, LOCATES_COMPLETE, EXPIRED, CANCELLED
  whiteLining            WhiteLiningSnapshot?
  meetTicket             MeetTicket?
  remarks                LocateRemark[]
  damageEvents           DamageEvent[]
  complianceEvents       ComplianceEvent[]
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt

  @@index([projectId])
  @@index([ticketNumber])
  @@index([status])
}

model WhiteLiningSnapshot {
  id               String     @id @default(cuid())
  ticketId         String     @unique
  gsocTicket       GsocTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  capturedByUserId String
  capturedBy       User       @relation(fields: [capturedByUserId], references: [id])
  capturedAt       DateTime   @default(now())
  locationGeometry String?    // PostGIS polygon/multipolygon as WKT or GeoJSON string for now
  fieldDescription String
  markColor        String     @default("WHITE") // WHITE, BLACK
  isOverMarked     Boolean    @default(false)
  photoUrls        String     @default("[]") // JSON array of strings
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([capturedByUserId])
}

model MeetTicket {
  id                       String         @id @default(cuid())
  ticketId                 String         @unique
  gsocTicket               GsocTicket     @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  requiredReason           String?        // LENGTH_1MILE, ADJACENT_TICKETS_1MILE, CROSSES_COUNTY, OPTIONAL_COMPLEXITY
  meetRequestedAt          DateTime?
  meetScheduledFor         DateTime?
  meetHeldAt               DateTime?
  meetLocation             String?
  documentationUrl         String?
  agreementMeetNotRequired Boolean        @default(false)
  agreementNotes           String?
  attendees                MeetAttendee[]
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
}

model MeetAttendee {
  id           String     @id @default(cuid())
  meetTicketId String
  meetTicket   MeetTicket @relation(fields: [meetTicketId], references: [id], onDelete: Cascade)
  name         String
  company      String?
  role         String?    // EXCAVATOR, FACILITY_OPERATOR, LOCATOR, OWNER
  phone        String?
  email        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([meetTicketId])
}

model LocateRemark {
  id           String     @id @default(cuid())
  ticketId     String
  gsocTicket   GsocTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  type         String     // REMARK_REQUESTED, REMARK_COMPLETED
  reason       String?    // MARKS_OBLITERATED, WRONG_LOCATION, ADDITIONAL_AREA, OTHER
  requestedAt  DateTime   @default(now())
  completedAt  DateTime?
  notes        String?
  photoUrls    String     @default("[]")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([ticketId])
}

model DamageEvent {
  id                         String     @id @default(cuid())
  ticketId                   String?
  gsocTicket                 GsocTicket? @relation(fields: [ticketId], references: [id])
  projectId                  String
  project                    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  occurredAt                 DateTime
  facilityType               String     // GAS, ELECTRIC, WATER, FIBER, SEWER, UNKNOWN
  contactWasMade             Boolean    @default(true)
  notifiedOperatorsAt        DateTime?
  emergencyServicesContacted Boolean    @default(false)
  description                String
  photoUrls                  String     @default("[]")
  createdAt                  DateTime   @default(now())
  updatedAt                  DateTime   @updatedAt

  @@index([ticketId])
  @@index([projectId])
}

model ComplianceEvent {
  id          String      @id @default(cuid())
  projectId   String
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ticketId    String?
  gsocTicket  GsocTicket? @relation(fields: [ticketId], references: [id])
  eventType   String      // TICKET_FILED, WHITE_LINING_CAPTURED, MEET_SCHEDULED, MEET_HELD, REMARK_REQUESTED, etc.
  timestamp   DateTime    @default(now())
  details     String?     // JSON or text details
  createdById String?
  createdBy   User?       @relation(fields: [createdById], references: [id])
  createdAt   DateTime    @default(now())

  @@index([projectId])
  @@index([ticketId])
  @@index([eventType])
}

// --- Scheduling Models ---

model Shift {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  crewId      String?
  crew        Crew?    @relation(fields: [crewId], references: [id])
  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id])
  
  startTime   DateTime
  endTime     DateTime
  
  status      String   @default("SCHEDULED") // SCHEDULED, CONFIRMED, COMPLETED, CANCELLED
  notes       String?
  
  assets      ShiftAsset[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([crewId])
  @@index([employeeId])
  @@index([startTime])
}

model ShiftAsset {
  id        String   @id @default(cuid())
  shiftId   String
  shift     Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id])
  
  createdAt DateTime @default(now())

  @@index([shiftId])
  @@index([assetId])
}

model ScheduleTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  data        String   // JSON blob
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
